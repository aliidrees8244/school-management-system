<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add / Edit Marks - Muslim Educators School</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    h1 {
      color: #003366;
      margin-bottom: 10px;
    }
    p {
      font-weight: 600;
      color: #003366;
    }
    select, input[type=number] {
      padding: 8px;
      font-size: 16px;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-right: 10px;
    }
    button {
      background-color: #1abc9c;
      color: white;
      border: none;
      padding: 10px 20px;
      font-weight: 700;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }
    button:hover {
      background-color: #159d86;
    }
    .back-btn {
      background-color: #2980b9;
    }
    .back-btn:hover {
      background-color: #1f5a88;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
    }
    th {
      background: #1abc9c;
      color: white;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Add / Edit Marks</h1>
  <p id="examDetails">Loading exam details...</p>

  <div>
    <label for="studentSelect">Select Student: </label>
    <select id="studentSelect"></select>

    <label for="marksInput">Marks: </label>
    <input type="number" id="marksInput" min="0" max="100" />

    <button id="saveMarkBtn">Save / Update</button>
    <button id="backBtn" class="back-btn">Back to Manage Exams</button>
  </div>

  <h2>Marks List</h2>
  <table id="marksTable">
    <thead>
      <tr>
        <th>Student Name</th>
        <th>Marks</th>
      </tr>
    </thead>
    <tbody>
      <tr><td colspan="2">No marks entered yet.</td></tr>
    </tbody>
  </table>
</div>

<script>
  function getQueryParams() {
    const params = {};
    location.search.substring(1).split('&').forEach(pair => {
      const [key, value] = pair.split('=');
      params[decodeURIComponent(key)] = decodeURIComponent(value || '');
    });
    return params;
  }

  const params = getQueryParams();
  const examName = params.exam || '';
  const className = params.class || '';
  const subject = params.subject || '';

  const examDetailsEl = document.getElementById('examDetails');
  const studentSelect = document.getElementById('studentSelect');
  const marksInput = document.getElementById('marksInput');
  const saveMarkBtn = document.getElementById('saveMarkBtn');
  const marksTableBody = document.querySelector('#marksTable tbody');

  if (!examName || !className || !subject) {
    examDetailsEl.textContent = 'Missing exam details.';
    saveMarkBtn.disabled = true;
  } else {
    examDetailsEl.textContent = `Exam: ${examName} | Class: ${className} | Subject: ${subject}`;
  }

  // Load students
  let students = JSON.parse(localStorage.getItem('students')) || [];
  students = students.filter(s => s.class === className);

  // Load marks
  const marksKey = `marks_${examName}_${className}_${subject}`;
  let marksData = JSON.parse(localStorage.getItem(marksKey)) || {};

  function populateDropdown() {
    studentSelect.innerHTML = '';
    if (students.length === 0) {
      studentSelect.innerHTML = '<option value="">No students found</option>';
      return;
    }
    students.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.id;
      opt.textContent = s.name;
      studentSelect.appendChild(opt);
    });
    loadSelectedStudentMarks();
  }

  function loadSelectedStudentMarks() {
    const studentId = studentSelect.value;
    marksInput.value = marksData[studentId] !== undefined ? marksData[studentId] : '';
  }

  function renderMarksTable() {
    marksTableBody.innerHTML = '';
    if (Object.keys(marksData).length === 0) {
      marksTableBody.innerHTML = '<tr><td colspan="2">No marks entered yet.</td></tr>';
      return;
    }
    students.forEach(s => {
      const mark = marksData[s.id] !== undefined ? marksData[s.id] : '-';
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${s.name}</td><td>${mark}</td>`;
      marksTableBody.appendChild(tr);
    });
  }

  saveMarkBtn.addEventListener('click', () => {
    const studentId = studentSelect.value;
    const mark = marksInput.value.trim();

    if (!studentId) {
      alert('Please select a student.');
      return;
    }
    if (mark === '' || isNaN(mark) || mark < 0 || mark > 100) {
      alert('Please enter valid marks between 0 and 100.');
      return;
    }

    marksData[studentId] = Number(mark);
    localStorage.setItem(marksKey, JSON.stringify(marksData));
    renderMarksTable();
    alert('Marks saved/updated successfully!');
  });

  studentSelect.addEventListener('change', loadSelectedStudentMarks);
  document.getElementById('backBtn').addEventListener('click', () => {
    window.location.href = 'exam-management.html';
  });

  populateDropdown();
  renderMarksTable();
</script>

</body>
</html>
